define("text!apps/sign/templates/main.html",[],function(){return'{{?_global.user}}\r\n<section class="regis-avatar">\r\n    <span><img src="{{= _global.user.photo}}" alt="{{= _global.user.nick_name}}"></span>\r\n</section>\r\n{{?}}\r\n<section class="regis-form">\r\n    <form onsubmit="return false";>\r\n        <div class="regis-input">\r\n            <label for="phone"><span class="iconfont">&#xe67e;</span></label>\r\n            <div class="input">\r\n                <input type="text" id="phone" placeholder="请输入您的手机号码">\r\n            </div>\r\n            <a href="javascript:;" class="clear iconfont">&#xe678;</a>\r\n        </div>\r\n        {{? it.param == \'regis\' || it.param == \'forget\'}}\r\n        <div class="regis-valid">\r\n            <div class="regis-input">\r\n                <label for="valid"><span class="iconfont">&#xe680;</span></label>\r\n                <div class="input">\r\n                    <input type="text" id="valid" placeholder="请输入验证码">\r\n                </div>\r\n            </div>\r\n            <a href="javascript:;" class="send" id="sign-valid">获取验证码</a>\r\n        </div>\r\n        {{?}}\r\n        {{? it.param == \'login\' }}\r\n        <div class="regis-input">\r\n            <label for="password"><span class="iconfont">&#xe67f;</span></label>\r\n            <div class="input">\r\n                <input type="password" id="password" placeholder="请输入您的帐号密码">\r\n            </div>\r\n        </div>\r\n        {{?? it.param == \'regis\' || it.param == \'forget\'}}\r\n        <div class="regis-input">\r\n            <label for="password"><span class="iconfont">&#xe67f;</span></label>\r\n            <div class="input">\r\n                <input type="password" id="password" placeholder="请设置您的帐号密码">\r\n            </div>\r\n        </div>\r\n        {{?}}\r\n        {{? it.param == \'login\' }}\r\n        <div class="regis-helptip">\r\n            <a href="javascript:;" class="change-type" data-type="forget"><span class="iconfont">&#xe66c;</span>忘记密码</a>\r\n        </div>\r\n        {{?}}\r\n        <div class="regis-confirm">\r\n            {{? it.param == \'regis\'}}\r\n            <button type="submit" id="sign-regis">立即{{?_global.is_wx==0}}注册{{??}}绑定{{?}}</button>\r\n            {{?? it.param == \'forget\'}}\r\n            <button type="submit" id="sign-forget">立即重置</button>\r\n            {{??}}\r\n            <button type="submit" id="sign-login">立即登录</button>\r\n            {{?}}\r\n        </div>\r\n    </form>\r\n</section>\r\n{{?_global.is_wx==0}}\r\n<section class="regis-jumping">\r\n    {{? it.param == \'regis\' || it.param == \'forget\'}}\r\n    <a href="javascript:;" class="change-type" data-type="login">已有账号，立即登录</a>\r\n    {{??}}\r\n    <a href="javascript:;" class="change-type" data-type="regis">如果没有账号，请立即注册</a>\r\n    {{?}}\r\n</section>\r\n{{?}}'}),define("apps/sign/models/sign",[],function(){return Backbone.Model.extend({initialize:function(e){this.urlApi=e},url:function(){return this.urlApi}})}),define("apps/sign/views/main",["doT","text!apps/sign/templates/main.html","apps/sign/models/sign"],function(e,t,n){return Backbone.View.extend({id:"view-registration",template:e.template(t),events:{"click #sign-login":"login","click #sign-regis":"register","click #sign-forget":"register","click #sign-valid":"verification","click .change-type":"changeType"},initialize:function(e){for(k in e)this[k]=e[k];$("#views").append(this.$el),$("body").css("padding-bottom","0"),this.param=$.getUrlParam("signType")?$.getUrlParam("signType"):"login",_global.user&&_global.user.mobile===""&&(this.param="regis"),this.render(),$.setForward()},render:function(){var e={param:this.param};return this.setTitle(this.param),this.$el.html(this.template(e)),$.loading("hide"),this},setTitle:function(e){var t={regis:_global.is_wx?"绑定":"注册",forget:"忘记密码",login:"登录"};$.setTitle(t[e])},login:function(){var e=this,t={mobile:this.$("#phone").val(),password:this.$("#password").val(),type:"pwd"};if(!this.checkPhone(t.mobile))return!1;if(!this.checkPwd(t.password))return!1;this.logModel=new n(this.urlLoginApi),this.logModel.save(t,{success:function(t,n){if(n.status===0)return layer.open({content:n.msg,time:1.5}),!1;_global.user=n.user,_global.shop.type=n.shop.type,_global.user&&_global.user.photo&&(_global.user=$.headImages(_global.user,"photo",96)),e.navigateUrl()},error:function(e,t){layer.open({content:t.responseText,time:1.5})}})},register:function(){var e=this,t={mobile:this.$("#phone").val(),password:this.$("#password").val(),sms_str:this.$("#valid").val(),type:this.param==="regis"?"register":"findPwd"};if(!this.checkPhone(t.mobile))return!1;if(!this.checkPwd(t.password))return!1;if(!this.checkValid(t.sms_str))return!1;if(!this.sendsms)return layer.open({content:"请先发送验证码",time:1.5}),!1;this.regModel=new n(this.urlRegApi+"?type="+t.type),this.regModel.save(t,{success:function(n,r){if(r.status===0)return layer.open({content:r.msg,time:1.5}),!1;t.type==="register"?(_global.user=r.user,_global.shop.type=r.shop.type,_global.user&&_global.user.photo&&(_global.user=$.headImages(_global.user,"photo",96)),e.navigateUrl()):e.navigateUrl("#sign")},error:function(e,t){layer.open({content:t.responseText,time:1.5})}})},verification:function(e){var t=this,r={mobile:this.$("#phone").val(),type:this.param==="regis"?"register":"findPwd"};if(!this.checkPhone(r.mobile))return!1;this.smsModel=new n(this.urlSmsApi),this.smsModel.fetch({data:r,success:function(n,r){if(r.status===0)return layer.open({content:r.msg,time:1.5}),!1;t.sendsms=!0,t.countdown=60,t.countDownTime(e)},error:function(e,t){layer.open({content:t.responseText,time:1.5})}})},checkPwd:function(e){return typeof e=="undefined"||e==""?(layer.open({content:"请输入您的密码",time:1.5}),$('input[name="password"]',this.$el).focus(),!1):e.length<6?(layer.open({content:"密码最短为6位",time:1.5}),$('input[name="password"]',this.$el).focus(),!1):e.length>20?(layer.open({content:"密码最长为20位",time:1.5}),$('input[name="password"]',this.$el).focus(),!1):!0},checkPhone:function(e){var t={mobile:{type:"validMobile",value:e,required:!0}},n=$.validity(t);return n.status?!0:(layer.open({content:n.error,time:1.5}),!1)},checkValid:function(e){var t={code:{type:"validPostalCode",value:e,required:!0}},n=$.validity(t);return n.status?!0:(layer.open({content:n.error,time:1.5}),!1)},countDownTime:function(e){var t=this,n=$(e.target),r=setTimeout(function(){t.countDownTime(e)},1e3);t.countdown===0?(n.prop("disabled",!1),n.removeClass("disabled"),n.text("获取验证码"),t.countdown=60,clearTimeout(r)):(n.addClass("disabled"),n.prop("disabled",!0),n.text("剩余 "+t.countdown+" 秒"),t.countdown--)},navigateUrl:function(e){if($.getUrlParam("preUrl")===null)e=e?e:"#";else{var t=window.location.hash;t=t.replace(/[?|&]signType=[A-Za-z0-9]+/g,""),e=t.substring(t.indexOf("preUrl")).replace("preUrl=","#")}Backbone.history.navigate(e,{trigger:!0})},changeType:function(e){var t=$(e.currentTarget);this.param=t.data("type"),this.render(this.param);var n=window.location.hash,r,i;$.getUrlParam("signType")!=null?r=n.replace(/signType=[A-Za-z0-9]+/g,"signType="+this.param):(n&&n.indexOf("?")!=-1?i="&":i="?",r=n+i+"signType="+this.param),Backbone.history.navigate(r,{replace:!0})}})}),define("apps/sign/app",["apps/sign/views/main"],function(e){var t={urlRegApi:"data/reg.php",urlLoginApi:"data/login.php",urlSmsApi:"data/sms.php",urlRegApi:"/site/reg",urlLoginApi:"/site/login",urlSmsApi:"/site/sms"};return{main:function(){this.mainView=new e(t)}}});